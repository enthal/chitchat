<script src='http://coffeescript.org/extras/coffee-script.js'></script>
<script src='https://ajax.googleapis.com/ajax/libs/angularjs/1.2.9/angular.js'></script>
<script src='https://s3-us-west-2.amazonaws.com/change-ds-tj/socket.io/socket.io.js'></script>

<script type='text/coffeescript'>
  socket = io.connect ':1338'
  messages = []

  angular.module('chitchat', [])

  .run( ($rootScope) ->
    socket
    .on('connect',    -> $rootScope.$apply -> $rootScope.isConnected = true)
    .on('disconnect', -> $rootScope.$apply -> $rootScope.isConnected = false)
    .on('messages', (new_messages) ->
      $rootScope.$apply ->
        messages.length = 0
        messages.push m  for m in new_messages
    )
    .on('message', (message) ->
      $rootScope.$apply ->
        messages.push message
    )
  )
  .controller('ChitChat', ($scope, $log) ->
    $scope.messages = messages
    $scope.sendMessage = ->
      return unless $scope.messageText
      socket.emit 'message', body:$scope.messageText
      $scope.messageText = ''
  )

</script>

<body ng-app='chitchat'>

  <h1>chitchat</h1>

  <div ng-controller='ChitChat'>
    <div ng-if=" isConnected">:-) connected</div>
    <div ng-if="!isConnected">:-( disconnected</div>

    <form ng-submit="sendMessage()">
      <input type="text" ng-model="messageText" placeholder="your message">
      <input type="submit" value="send">
    </form>

    <label>{{messages.length}} messages</label>
    <ul>
      <li ng-repeat='message in messages'>{{message.body}}</li>
    </ul>
  </div>

</body>


<!-- allow coffeescript to convert before angular bootstraps -->
<script type='text/coffeescript'> angular.resumeBootstrap() </script>
<script> window.name = 'NG_DEFER_BOOTSTRAP!'</script>
